<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Analizador Semántico RSL</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}" />
    <link
      rel="icon"
      href="{{ url_for('static', filename='assets/logo.png') }}"
      type="image/png" />
  </head>

  <body>
    <header>
      <img
        src="{{ url_for('static', filename='assets/logo.png') }}"
        alt="Logo del sitio" />
      <h1>Analizador Semántico para RSL</h1>
    </header>
    <div class="container">
      <p>
        Aqui podras visualizar los gráficos estadísticos de los datos obtenidos
        de la búsqueda de artículos científicos realizada.
      </p>
      <div class="demo">
        <div class="line"></div>
        <h3>¡PRUEBA NUESTRA DEMO!</h3>
        <div class="line"></div>
      </div>

      <div class="first-chart">
        <h3>Gráfico de Países</h3>
        <div class="chart-actions">
          <button onclick="exportChart('geoChart', 'mapa-paises')">Exportar Mapa</button>
        </div>
        <div id="chart_paises" class="chart-container">
          <canvas id="geoChart" width="800" height="400"></canvas>
        </div>
      </div>

      <div class="first-chart">
        <h3>Gráfico por Año</h3>
        <div class="chart-actions">
          <button onclick="exportChart('yearChart', 'grafico-anios')">Exportar Gráfico</button>
        </div>
        <div id="chart_anio" class="chart-container">
          <canvas id="yearChart"></canvas>
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2025 - Proyecto de RSL | UTP</p>
    </footer>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script
      type="text/javascript"
      src="https://unpkg.com/chartjs-chart-geo@3.5.2/build/index.umd.min.js"></script>
    <script>
      function exportChart(chartId, fileName) {
        const chart = Chart.getChart(chartId);
        if (chart) {
          const link = document.createElement('a');
          link.download = `${fileName}.png`;
          link.href = chart.toBase64Image();
          link.click();
        }
      }

      function formatNumber(num) {
        return num.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
      }

      function configureChartResponsive(chart) {
        function resizeChart() {
          chart.resize();
        }
        window.addEventListener('resize', resizeChart);
      }

      fetch("/dataestadistica")
        .then((res) => res.json())
        .then((data) => {
          console.log(data);
          countriesData = data.data.map((item) => item.pais);

          const countryCount = countriesData.reduce((acc, pais) => {
            acc[pais] = (acc[pais] || 0) + 1;
            return acc;
          }, {});

          console.log(countryCount);

          //Procesamiento de datos para el gráfico de años
          const yearsData = data.data.map((item) => item.anio);
          const yearCount = yearsData.reduce((acc, year) => {
            if (year && year !== "No detectado") {
              acc[year] = (acc[year] || 0) + 1;
            }
            return acc;
          }, {});

          //Ordenar los años de más reciente a más antiguo
          const sortedYears = Object.keys(yearCount).sort((a, b) => b - a);
          const yearLabels = sortedYears;
          const yearValues = sortedYears.map(year => yearCount[year]);
          
          //Calcular porcentajes
          const totalArticles = yearValues.reduce((a, b) => a + b, 0);
          const yearPercentages = yearValues.map(value => 
            ((value / totalArticles) * 100).toFixed(2) + '%'
          );

          //Crear etiquetas completas (año - cantidad - porcentaje)
          const fullLabels = yearLabels.map((year, i) => 
            `${year} - ${yearValues[i]} (${yearPercentages[i]})`
          );

          fetch("https://unpkg.com/world-atlas@2.0.2/countries-50m.json")
            .then((res) => res.json())
            .then((datapoint) => {
              const countries = ChartGeo.topojson.feature(
                datapoint,
                datapoint.objects.countries
              ).features;
              let countriesData = [];

              const chartData = countries.map((d) => ({
                feature: d,
                value: countryCount[d.properties.name] || 0,
              }));

              const data = {
                labels: countries.map((country) => country.properties.name),
                datasets: [
                  {
                    label: "Countries",
                    data: chartData,
                    outline: countries,
                    colorScale: {
                      quantize: 2,
                      legend: {
                        position: "bottom-right",
                        align: "bottom",
                      },
                       interpolate: t => t > 0 ? "#ff5733" : "#e0e0e0"
                    },
                  },
                ],
              };

              const config = {
                type: "choropleth",
                data,
                options: {
                  scales: {
                    xy: {
                      projection: "equalEarth",
                    },
                  },
                  plugins: {
                    legend: {
                      display: false,
                    },
                  },
                },
              };

              const myChart = new Chart(
                document.getElementById("geoChart"),
                config
              );
            });
            
          //Gráfico circular por año
          const yearChartCtx = document.getElementById('yearChart').getContext('2d');
          
          const yearChart = new Chart(yearChartCtx, {
            type: 'doughnut',
            data: {
              labels: fullLabels,
              datasets: [{
                data: yearValues,
                backgroundColor: [
                  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                  '#FF9F40', '#8AC24A', '#607D8B', '#E91E63', '#00BCD4'
                ],
                borderWidth: 1,
                hoverBackgroundColor: [
                  '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                  '#FF9F40', '#8AC24A', '#607D8B', '#E91E63', '#00BCD4'
                ].map(color => color + 'DD'),
                hoverBorderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'right',
                  labels: {
                    font: {
                      size: 12
                    },
                    padding: 20
                  }
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const label = context.label || '';
                      const value = context.raw || 0;
                      const percentage = yearPercentages[context.dataIndex];
                      return `${label}: ${value} artículos (${percentage})`;
                    }
                  }
                }
              },
              cutout: '50%',
              animation: {
                animateScale: true,
                animateRotate: true
              }
            }
          });
          
          configureChartResponsive(yearChart);
        });
    </script>
  </body>
</html>
